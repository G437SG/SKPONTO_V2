{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-sync"></i> Monitoramento em Tempo Real</h2>
                <div class="btn-group">
                    <a href="{{ url_for('debug.debug_dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    <button type="button" class="btn btn-success" id="toggleMonitoring">
                        <i class="fas fa-play"></i> Iniciar
                    </button>
                    <button type="button" class="btn btn-warning" onclick="clearRealtime()">
                        <i class="fas fa-trash"></i> Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status do Monitoramento -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="status-indicator me-2" id="statusIndicator"></div>
                                <div>
                                    <h6 class="mb-0">Status do Sistema</h6>
                                    <small class="text-muted" id="statusText">Parado</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h6 class="mb-0" id="uptimeText">Tempo Online: 00:00:00</h6>
                            <small class="text-muted">Desde o último reinício</small>
                        </div>
                        <div class="col-md-3">
                            <h6 class="mb-0" id="requestsCount">Requisições: 0</h6>
                            <small class="text-muted">Últimos 60 segundos</small>
                        </div>
                        <div class="col-md-3">
                            <h6 class="mb-0" id="errorsCount">Erros: 0</h6>
                            <small class="text-muted">Últimos 60 segundos</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos em Tempo Real -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Monitoramento de Erros (Tempo Real)</h5>
                </div>
                <div class="card-body">
                    <canvas id="realtimeChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Métricas do Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>CPU:</span>
                            <span id="cpuUsage">0%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-info" id="cpuBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Memória:</span>
                            <span id="memoryUsage">0%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-warning" id="memoryBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Conexões Ativas:</span>
                            <span id="activeConnections">0</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="d-flex justify-content-between">
                            <span>Tempo de Resposta:</span>
                            <span id="responseTime">0ms</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log em Tempo Real -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">Log em Tempo Real</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoScroll" checked>
                        <label class="form-check-label" for="autoScroll">
                            Auto-scroll
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="realtimeLogsContainer" class="bg-dark text-white p-3" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div id="realtimeLogsContent">
                            <div class="text-center text-muted">Aguardando eventos...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="errorToast" class="toast" role="alert">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong class="me-auto">Novo Erro Detectado</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="errorToastBody">
            <!-- Mensagem do erro -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let monitoringActive = false;
let monitoringInterval;
let realtimeChart;
let startTime;
let eventCount = 0;

// Dados para o gráfico
let chartData = {
    labels: [],
    datasets: [{
        label: 'Erros',
        data: [],
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        tension: 0.1
    }, {
        label: 'Requisições',
        data: [],
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.1)',
        tension: 0.1
    }]
};

function initRealtimeChart() {
    const ctx = document.getElementById('realtimeChart').getContext('2d');
    realtimeChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Tempo'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantidade'
                    }
                }
            },
            animation: {
                duration: 0
            }
        }
    });
}

function toggleMonitoring() {
    const button = document.getElementById('toggleMonitoring');
    
    if (!monitoringActive) {
        startMonitoring();
        button.innerHTML = '<i class="fas fa-stop"></i> Parar';
        button.className = 'btn btn-danger';
    } else {
        stopMonitoring();
        button.innerHTML = '<i class="fas fa-play"></i> Iniciar';
        button.className = 'btn btn-success';
    }
}

function startMonitoring() {
    monitoringActive = true;
    startTime = new Date();
    eventCount = 0;
    
    updateStatus('Ativo', 'success');
    
    // Buscar dados a cada 5 segundos
    monitoringInterval = setInterval(fetchRealtimeData, 5000);
    
    // Atualizar uptime a cada segundo
    setInterval(updateUptime, 1000);
    
    // Primeira busca imediata
    fetchRealtimeData();
}

function stopMonitoring() {
    monitoringActive = false;
    
    if (monitoringInterval) {
        clearInterval(monitoringInterval);
    }
    
    updateStatus('Parado', 'secondary');
}

function updateStatus(text, type) {
    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    indicator.className = `status-indicator me-2 status-${type}`;
    statusText.textContent = text;
}

function updateUptime() {
    if (!monitoringActive || !startTime) return;
    
    const now = new Date();
    const diff = now - startTime;
    
    const hours = Math.floor(diff / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    
    const uptimeText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('uptimeText').textContent = `Tempo Online: ${uptimeText}`;
}

function fetchRealtimeData() {
    if (!monitoringActive) return;
    
    fetch('/admin/debug/api/realtime')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateChartData(data);
                updateMetrics(data.metrics);
                updateRecentEvents(data.recent_events);
                
                // Verificar novos erros
                if (data.new_errors && data.new_errors.length > 0) {
                    showErrorNotification(data.new_errors[0]);
                }
            }
        })
        .catch(error => {
            console.error('Erro ao buscar dados em tempo real:', error);
        });
}

function updateChartData(data) {
    const now = new Date().toLocaleTimeString();
    
    // Adicionar novo ponto
    chartData.labels.push(now);
    chartData.datasets[0].data.push(data.errors_count || 0);
    chartData.datasets[1].data.push(data.requests_count || 0);
    
    // Manter apenas os últimos 20 pontos
    if (chartData.labels.length > 20) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
        chartData.datasets[1].data.shift();
    }
    
    realtimeChart.update('none');
    
    // Atualizar contadores
    document.getElementById('requestsCount').textContent = `Requisições: ${data.requests_count || 0}`;
    document.getElementById('errorsCount').textContent = `Erros: ${data.errors_count || 0}`;
}

function updateMetrics(metrics) {
    if (!metrics) return;
    
    // CPU
    const cpuUsage = metrics.cpu_percent || 0;
    document.getElementById('cpuUsage').textContent = `${cpuUsage.toFixed(1)}%`;
    document.getElementById('cpuBar').style.width = `${cpuUsage}%`;
    
    // Memória
    const memoryUsage = metrics.memory_percent || 0;
    document.getElementById('memoryUsage').textContent = `${memoryUsage.toFixed(1)}%`;
    document.getElementById('memoryBar').style.width = `${memoryUsage}%`;
    
    // Outras métricas
    document.getElementById('activeConnections').textContent = metrics.active_connections || 0;
    document.getElementById('responseTime').textContent = `${metrics.response_time || 0}ms`;
}

function updateRecentEvents(events) {
    if (!events || events.length === 0) return;
    
    const container = document.getElementById('realtimeLogsContent');
    const autoScroll = document.getElementById('autoScroll').checked;
    
    events.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'log-entry mb-1';
        
        let levelClass = 'text-white';
        switch (event.level) {
            case 'DEBUG': levelClass = 'text-secondary'; break;
            case 'INFO': levelClass = 'text-info'; break;
            case 'WARNING': levelClass = 'text-warning'; break;
            case 'ERROR': levelClass = 'text-danger'; break;
            case 'CRITICAL': levelClass = 'text-danger fw-bold'; break;
        }
        
        eventDiv.innerHTML = `
            <span class="text-muted">${new Date(event.timestamp).toLocaleTimeString()}</span>
            <span class="badge bg-secondary">${event.level || 'INFO'}</span>
            <span class="${levelClass}">${event.message}</span>
        `;
        
        container.appendChild(eventDiv);
        eventCount++;
    });
    
    // Limitar a 100 eventos
    while (container.children.length > 100) {
        container.removeChild(container.firstChild);
    }
    
    // Auto-scroll
    if (autoScroll) {
        const logsContainer = document.getElementById('realtimeLogsContainer');
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }
}

function showErrorNotification(error) {
    const toast = document.getElementById('errorToast');
    const toastBody = document.getElementById('errorToastBody');
    
    toastBody.innerHTML = `
        <strong>${error.error_type}</strong><br>
        <small>${error.error_message}</small>
    `;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

function clearRealtime() {
    // Limpar gráfico
    chartData.labels = [];
    chartData.datasets[0].data = [];
    chartData.datasets[1].data = [];
    realtimeChart.update();
    
    // Limpar logs
    const container = document.getElementById('realtimeLogsContent');
    container.innerHTML = '<div class="text-center text-muted">Aguardando eventos...</div>';
    
    // Reset contadores
    eventCount = 0;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initRealtimeChart();
    
    document.getElementById('toggleMonitoring').addEventListener('click', toggleMonitoring);
});

// Limpar intervals ao sair da página
window.addEventListener('beforeunload', function() {
    if (monitoringInterval) {
        clearInterval(monitoringInterval);
    }
});
</script>

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.status-success {
    background-color: #28a745;
    animation: pulse 2s infinite;
}

.status-secondary {
    background-color: #6c757d;
}

.status-danger {
    background-color: #dc3545;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.metric-item {
    font-size: 0.9rem;
}

.log-entry {
    border-bottom: 1px solid #333;
    padding: 2px 0;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.log-entry:hover {
    background-color: #2a2a2a;
}

#realtimeLogsContainer::-webkit-scrollbar {
    width: 8px;
}

#realtimeLogsContainer::-webkit-scrollbar-track {
    background: #1a1a1a;
}

#realtimeLogsContainer::-webkit-scrollbar-thumb {
    background: #666;
    border-radius: 4px;
}

#realtimeLogsContainer::-webkit-scrollbar-thumb:hover {
    background: #888;
}
</style>
{% endblock %}
