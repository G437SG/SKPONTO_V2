{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-bug"></i> Dashboard de Debug</h2>
                <div class="btn-group">
                    <button type="button" class="btn btn-warning" onclick="testError()">
                        <i class="fas fa-exclamation-triangle"></i> Testar Erro
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearErrors()">
                        <i class="fas fa-trash"></i> Limpar Erros
                    </button>
                    <a href="{{ url_for('debug.debug_logs') }}" class="btn btn-info">
                        <i class="fas fa-file-alt"></i> Ver Logs
                    </a>
                    <a href="{{ url_for('debug.debug_realtime') }}" class="btn btn-success">
                        <i class="fas fa-sync"></i> Tempo Real
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.total_errors }}</h4>
                            <p class="card-text">Total de Erros</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.recent_errors }}</h4>
                            <p class="card-text">Última Hora</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="error-types-count">{{ stats.error_types|length }}</h4>
                            <p class="card-text">Tipos de Erro</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tags fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="system-status">Online</h4>
                            <p class="card-text">Status do Sistema</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Erros por Hora (Últimas 24h)</h5>
                </div>
                <div class="card-body">
                    <canvas id="errorsChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Tipos de Erro</h5>
                </div>
                <div class="card-body">
                    <canvas id="errorTypesChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Erros Recentes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">Erros Recentes</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshErrors()">
                        <i class="fas fa-sync"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="errorsTable">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Tipo</th>
                                    <th>Mensagem</th>
                                    <th>Rota</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for error in recent_errors %}
                                <tr>
                                    <td>
                                        <small class="text-muted">
                                            {{ moment(error.timestamp).format('DD/MM/YYYY HH:mm:ss') }}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge badge-danger">{{ error.error_type }}</span>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;" title="{{ error.error_message }}">
                                            {{ error.error_message }}
                                        </div>
                                    </td>
                                    <td>
                                        {% if error.request_info and error.request_info.endpoint %}
                                            <code>{{ error.request_info.endpoint }}</code>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                onclick="showErrorDetails({{ loop.index0 }})">
                                            <i class="fas fa-eye"></i> Detalhes
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes do Erro -->
<div class="modal fade" id="errorDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Erro</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="errorDetailsContent">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dados dos erros para JavaScript
let errorsData = {{ recent_errors|tojson }};

// Gráfico de erros por hora
let errorsChart;
let errorTypesChart;

function initCharts() {
    // Buscar dados atualizados
    fetch('/admin/debug/api/stats')
        .then(response => response.json())
        .then(data => {
            // Gráfico de erros por hora
            const ctx1 = document.getElementById('errorsChart').getContext('2d');
            const hourlyData = data.hourly_stats || {};
            
            errorsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Object.keys(hourlyData),
                    datasets: [{
                        label: 'Erros por Hora',
                        data: Object.values(hourlyData),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Gráfico de tipos de erro
            const ctx2 = document.getElementById('errorTypesChart').getContext('2d');
            const errorTypes = data.error_types || {};
            
            errorTypesChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(errorTypes),
                    datasets: [{
                        data: Object.values(errorTypes),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        });
}

function testError() {
    fetch('/admin/debug/api/test-error')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Erro de teste gerado! Atualize a página para ver.');
            }
        });
}

function clearErrors() {
    if (confirm('Tem certeza que deseja limpar todos os erros?')) {
        fetch('/admin/debug/api/errors/clear', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }
}

function refreshErrors() {
    fetch('/admin/debug/api/errors?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                errorsData = data.errors;
                updateErrorsTable();
            }
        });
}

function updateErrorsTable() {
    const tbody = document.querySelector('#errorsTable tbody');
    tbody.innerHTML = '';
    
    errorsData.forEach((error, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><small class="text-muted">${new Date(error.timestamp).toLocaleString()}</small></td>
            <td><span class="badge badge-danger">${error.error_type}</span></td>
            <td>
                <div class="text-truncate" style="max-width: 300px;" title="${error.error_message}">
                    ${error.error_message}
                </div>
            </td>
            <td>
                ${error.request_info && error.request_info.endpoint ? 
                  `<code>${error.request_info.endpoint}</code>` : 
                  '<span class="text-muted">N/A</span>'}
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-info" onclick="showErrorDetails(${index})">
                    <i class="fas fa-eye"></i> Detalhes
                </button>
            </td>
        `;
    });
}

function showErrorDetails(index) {
    const error = errorsData[index];
    if (!error) return;
    
    const content = document.getElementById('errorDetailsContent');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Informações Básicas</h6>
                <table class="table table-sm">
                    <tr><td><strong>Tipo:</strong></td><td>${error.error_type}</td></tr>
                    <tr><td><strong>Timestamp:</strong></td><td>${new Date(error.timestamp).toLocaleString()}</td></tr>
                    <tr><td><strong>Mensagem:</strong></td><td>${error.error_message}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Informações da Requisição</h6>
                <table class="table table-sm">
                    ${error.request_info ? `
                        <tr><td><strong>Método:</strong></td><td>${error.request_info.method || 'N/A'}</td></tr>
                        <tr><td><strong>URL:</strong></td><td>${error.request_info.url || 'N/A'}</td></tr>
                        <tr><td><strong>Endpoint:</strong></td><td>${error.request_info.endpoint || 'N/A'}</td></tr>
                        <tr><td><strong>IP:</strong></td><td>${error.request_info.remote_addr || 'N/A'}</td></tr>
                    ` : '<tr><td colspan="2">Nenhuma informação de requisição</td></tr>'}
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Contexto</h6>
                <pre class="bg-light p-2"><code>${JSON.stringify(error.context, null, 2)}</code></pre>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Traceback</h6>
                <pre class="bg-dark text-white p-2" style="max-height: 300px; overflow-y: auto;"><code>${error.traceback}</code></pre>
            </div>
        </div>
    `;
    
    $('#errorDetailsModal').modal('show');
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    
    // Auto-refresh a cada 30 segundos
    setInterval(refreshErrors, 30000);
});
</script>
{% endblock %}
