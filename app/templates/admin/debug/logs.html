{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-file-alt"></i> Logs do Sistema</h2>
                <div class="btn-group">
                    <a href="{{ url_for('debug.debug_dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    <button type="button" class="btn btn-primary" onclick="refreshLogs()">
                        <i class="fas fa-sync"></i> Atualizar
                    </button>
                    <button type="button" class="btn btn-warning" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> Limpar Logs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="levelFilter" class="form-label">Nível</label>
                            <select class="form-control" id="levelFilter">
                                <option value="">Todos</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="CRITICAL">CRITICAL</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="dateFrom" class="form-label">Data Inicial</label>
                            <input type="datetime-local" class="form-control" id="dateFrom">
                        </div>
                        <div class="col-md-3">
                            <label for="dateTo" class="form-label">Data Final</label>
                            <input type="datetime-local" class="form-control" id="dateTo">
                        </div>
                        <div class="col-md-3">
                            <label for="searchTerm" class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="searchTerm" placeholder="Palavra-chave...">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas dos Logs -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h5 class="card-title text-secondary" id="debugCount">0</h5>
                    <p class="card-text">DEBUG</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title" id="infoCount">0</h5>
                    <p class="card-text">INFO</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title" id="warningCount">0</h5>
                    <p class="card-text">WARNING</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title" id="errorCount">0</h5>
                    <p class="card-text">ERROR</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center bg-dark text-white">
                <div class="card-body">
                    <h5 class="card-title" id="criticalCount">0</h5>
                    <p class="card-text">CRITICAL</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title" id="totalCount">0</h5>
                    <p class="card-text">TOTAL</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">Logs do Sistema</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh">
                        <label class="form-check-label" for="autoRefresh">
                            Auto-refresh (10s)
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="logsContainer" class="bg-dark text-white p-3" style="height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div id="logsContent">
                            <!-- Logs serão carregados aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval;
let currentLogs = [];

function loadLogs() {
    const params = new URLSearchParams();
    
    const level = document.getElementById('levelFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const search = document.getElementById('searchTerm').value;
    
    if (level) params.append('level', level);
    if (dateFrom) params.append('from', dateFrom);
    if (dateTo) params.append('to', dateTo);
    if (search) params.append('search', search);
    
    fetch(`/admin/debug/api/logs?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentLogs = data.logs;
                displayLogs(data.logs);
                updateLogStats(data.logs);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar logs:', error);
        });
}

function displayLogs(logs) {
    const container = document.getElementById('logsContent');
    container.innerHTML = '';
    
    if (logs.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">Nenhum log encontrado</div>';
        return;
    }
    
    logs.forEach(log => {
        const logDiv = document.createElement('div');
        logDiv.className = 'log-entry mb-1';
        
        let levelClass = 'text-white';
        switch (log.level) {
            case 'DEBUG': levelClass = 'text-secondary'; break;
            case 'INFO': levelClass = 'text-info'; break;
            case 'WARNING': levelClass = 'text-warning'; break;
            case 'ERROR': levelClass = 'text-danger'; break;
            case 'CRITICAL': levelClass = 'text-danger fw-bold'; break;
        }
        
        logDiv.innerHTML = `
            <span class="text-muted">${log.timestamp}</span>
            <span class="badge bg-secondary">${log.level}</span>
            <span class="${levelClass}">${log.message}</span>
        `;
        
        container.appendChild(logDiv);
    });
    
    // Scroll para o final
    const logsContainer = document.getElementById('logsContainer');
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

function updateLogStats(logs) {
    const stats = {
        DEBUG: 0,
        INFO: 0,
        WARNING: 0,
        ERROR: 0,
        CRITICAL: 0
    };
    
    logs.forEach(log => {
        if (stats.hasOwnProperty(log.level)) {
            stats[log.level]++;
        }
    });
    
    document.getElementById('debugCount').textContent = stats.DEBUG;
    document.getElementById('infoCount').textContent = stats.INFO;
    document.getElementById('warningCount').textContent = stats.WARNING;
    document.getElementById('errorCount').textContent = stats.ERROR;
    document.getElementById('criticalCount').textContent = stats.CRITICAL;
    document.getElementById('totalCount').textContent = logs.length;
}

function refreshLogs() {
    loadLogs();
}

function clearLogs() {
    if (confirm('Tem certeza que deseja limpar todos os logs?')) {
        fetch('/admin/debug/api/logs/clear', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadLogs();
                    alert('Logs limpos com sucesso!');
                }
            });
    }
}

function toggleAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');
    
    if (checkbox.checked) {
        autoRefreshInterval = setInterval(loadLogs, 10000);
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    
    // Filtros
    document.getElementById('levelFilter').addEventListener('change', loadLogs);
    document.getElementById('dateFrom').addEventListener('change', loadLogs);
    document.getElementById('dateTo').addEventListener('change', loadLogs);
    document.getElementById('searchTerm').addEventListener('input', debounce(loadLogs, 500));
    
    // Auto-refresh
    document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
});

// Debounce function para busca
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Limpar interval ao sair da página
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>

<style>
.log-entry {
    border-bottom: 1px solid #333;
    padding: 2px 0;
}

.log-entry:hover {
    background-color: #2a2a2a;
}

#logsContainer::-webkit-scrollbar {
    width: 8px;
}

#logsContainer::-webkit-scrollbar-track {
    background: #1a1a1a;
}

#logsContainer::-webkit-scrollbar-thumb {
    background: #666;
    border-radius: 4px;
}

#logsContainer::-webkit-scrollbar-thumb:hover {
    background: #888;
}
</style>
{% endblock %}
