{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-cloud me-2"></i>{{ title }}
                </h1>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary" onclick="testConnection()">
                        <i class="fas fa-wifi me-1"></i>Testar Conexão
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="forceSync()">
                        <i class="fas fa-sync me-1"></i>Sincronizar
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="createBackup()">
                        <i class="fas fa-save me-1"></i>Backup Manual
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row mb-4">
        <!-- Status do Link Compartilhado -->
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    {% if shared_link %}
                        <div class="text-success mb-2">
                            <i class="fas fa-link fa-2x"></i>
                        </div>
                        <h6 class="card-title text-success">LINK ATIVO</h6>
                        <small class="text-muted">Pasta compartilhada configurada</small>
                    {% else %}
                        <div class="text-warning mb-2">
                            <i class="fas fa-link-slash fa-2x"></i>
                        </div>
                        <h6 class="card-title text-warning">SEM LINK</h6>
                        <small class="text-muted">Configure o link compartilhado</small>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Status do Backup -->
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    {% if shared_link %}
                        <div class="text-success mb-2">
                            <i class="fas fa-cloud-upload-alt fa-2x"></i>
                        </div>
                        <h6 class="card-title text-success">BACKUP ATIVO</h6>
                        <small class="text-muted">Sistema de backup configurado</small>
                    {% else %}
                        <div class="text-warning mb-2">
                            <i class="fas fa-cloud-upload-alt fa-2x"></i>
                        </div>
                        <h6 class="card-title text-warning">BACKUP INATIVO</h6>
                        <small class="text-muted">Configure o link primeiro</small>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tipo de Backup -->
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="fas fa-hand-paper fa-2x"></i>
                    </div>
                    <h6 class="card-title text-info">UPLOAD MANUAL</h6>
                    <small class="text-muted">Backup local + guia de upload</small>
                </div>
            </div>
        </div>

        <!-- Instruções -->
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="fas fa-info-circle fa-2x"></i>
                    </div>
                    <h6 class="card-title text-primary">AJUDA</h6>
                    <small class="text-muted">Guia completo disponível</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações Detalhadas -->
    <div class="row">
        <!-- Pasta Dropbox Compartilhada -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-folder me-2"></i>Pasta de Backup
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#editSharedLinkModal"
                            title="Editar link da pasta compartilhada">
                        <i class="fas fa-edit me-1"></i>Editar Link
                    </button>
                </div>
                <div class="card-body">
                    {% if shared_link %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-link me-2"></i>Link da Pasta Compartilhada:
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" value="{{ shared_link }}" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ shared_link }}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <a href="{{ shared_link }}" target="_blank" class="btn btn-outline-primary">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </div>
                        
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Pasta Configurada!</strong><br>
                            <small>
                                ✅ {{ shared_folder_info.provider_name or 'Provedor' }} configurado<br>
                                📤 Estrutura de pastas criada automaticamente<br>
                                🔄 Sistema de backup ativo<br>
                                � Pastas locais sincronizadas
                            </small>
                        </div>
                        
                        {% if shared_folder_info.provider %}
                        <div class="mb-3">
                            <h6><i class="fas fa-info-circle text-info me-2"></i>Informações da Configuração:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small><strong>Provedor:</strong> {{ shared_folder_info.provider_name }}</small><br>
                                    <small><strong>Pasta Local:</strong> <code>shared_storage/SKPONTO_Data/</code></small>
                                </div>
                                <div class="col-md-6">
                                    {% if shared_folder_info.storage_stats %}
                                    <small><strong>Estatísticas:</strong></small><br>
                                    {% for folder_name, stats in shared_folder_info.storage_stats.items() %}
                                        {% if stats.exists and stats.file_count > 0 %}
                                        <small>{{ folder_name.title() }}: {{ stats.file_count }} arquivos ({{ stats.size_mb }} MB)</small><br>
                                        {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" onclick="createBackupWithSharedLink()">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Criar Backup Agora
                            </button>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-folder-plus fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Nenhuma pasta configurada</h6>
                            <p class="text-muted small">Configure o link da pasta compartilhada do Dropbox para ativar os backups.</p>
                            <button type="button" class="btn btn-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editSharedLinkModal">
                                <i class="fas fa-plus me-2"></i>Configurar Pasta
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Informações do Sistema -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Como Funciona
                    </h5>
                </div>
                <div class="card-body">
                    {% if shared_link %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Sistema Configurado!</strong><br>
                            <small>
                                ✅ Pasta compartilhada configurada<br>
                                📁 Backups locais criados automaticamente<br>
                                📄 Guia de upload gerado após cada backup<br>
                                🔄 Upload manual via instruções
                            </small>
                        </div>
                        
                        <h6><i class="fas fa-cog text-primary me-2"></i>Processo de Backup:</h6>
                        <ol class="list-group list-group-numbered">
                            <li class="list-group-item">Sistema cria backup local do banco de dados</li>
                            <li class="list-group-item">Backup é salvo na pasta <code>backups/</code></li>
                            <li class="list-group-item">Guia de upload é gerado automaticamente</li>
                            <li class="list-group-item">Você faz upload manual seguindo as instruções</li>
                        </ol>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Sistema Não Configurado</strong><br>
                            <small>Configure o link da pasta compartilhada para ativar o sistema de backup.</small>
                        </div>
                        
                        <h6><i class="fas fa-lightbulb text-info me-2"></i>Vantagens do Sistema:</h6>
                        <ul class="list-unstyled ps-3">
                            <li><i class="fas fa-check text-success me-2"></i>Configuração muito simples</li>
                            <li><i class="fas fa-check text-success me-2"></i>Não precisa de tokens OAuth</li>
                            <li><i class="fas fa-check text-success me-2"></i>Controle total sobre os uploads</li>
                            <li><i class="fas fa-check text-success me-2"></i>Instruções claras a cada backup</li>
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas de Backup -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Sistema de Backup via Link Compartilhado
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <h6 class="text-muted">Tipo de Backup</h6>
                            <p class="h5 text-success">Manual Assistido</p>
                            <small class="text-muted">Sistema cria backup local e instruções</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h6 class="text-muted">Localização</h6>
                            <p class="h5 text-info">Pasta Compartilhada</p>
                            <small class="text-muted">Dropbox via link compartilhado</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h6 class="text-muted">Facilidade</h6>
                            <p class="h5 text-warning">Muito Simples</p>
                            <small class="text-muted">Sem tokens OAuth necessários</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h6 class="text-muted">Controle</h6>
                            <p class="h5 text-primary">Total</p>
                            <small class="text-muted">Você decide quando fazer upload</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Instruções -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Sistema de Backup Simplificado
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-rocket text-success me-2"></i>Vantagens do Sistema</h6>
                            <ul class="list-unstyled ps-3">
                                <li><i class="fas fa-check text-success me-2"></i>Configuração extremamente simples</li>
                                <li><i class="fas fa-check text-success me-2"></i>Sem necessidade de tokens OAuth</li>
                                <li><i class="fas fa-check text-success me-2"></i>Sem problemas de expiração de token</li>
                                <li><i class="fas fa-check text-success me-2"></i>Controle total sobre os uploads</li>
                                <li><i class="fas fa-check text-success me-2"></i>Instruções geradas automaticamente</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-cogs text-primary me-2"></i>Como Funciona</h6>
                            <ul class="list-unstyled ps-3">
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Sistema cria backup local (.zip)</li>
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Gera arquivo de instruções</li>
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Você acessa a pasta compartilhada</li>
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Faz upload do arquivo de backup</li>
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Simples, confiável e eficaz!</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Dica:</strong> Este sistema elimina todos os problemas relacionados a tokens OAuth do Dropbox. 
                                É mais confiável, mais simples de configurar e funciona sempre. Você mantém o controle total sobre 
                                quando e como os backups são enviados para o Dropbox.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição do Link Compartilhado -->
<div class="modal fade" id="editSharedLinkModal" tabindex="-1" aria-labelledby="editSharedLinkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editSharedLinkModalLabel">
                    <i class="fas fa-folder me-2"></i>Configurar Pasta de Backup
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="sharedLinkForm" method="POST" action="{{ url_for('admin.update_shared_link') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Provedores Suportados:</strong> 
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <strong>Como configurar:</strong>
                                <ol class="mb-0 mt-1">
                                    <li>Acesse sua conta na nuvem</li>
                                    <li>Crie uma pasta "SKPONTO_Backups"</li>
                                    <li>Compartilhe a pasta (link público)</li>
                                    <li>Copie o link e cole abaixo</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <strong>Suportados:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>🟦 Dropbox</li>
                                    <li>🟥 Google Drive</li>
                                    <li>🟨 OneDrive</li>
                                    <li>🟫 MEGA</li>
                                    <li>🟪 Box</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shared_link" class="form-label">
                            <i class="fas fa-link me-2"></i>Link da Pasta Compartilhada
                        </label>
                        <input type="url" class="form-control" id="shared_link" name="shared_link" 
                               value="{{ shared_link or '' }}" 
                               placeholder="https://www.dropbox.com/... ou https://drive.google.com/... etc"
                               required>
                        <div class="form-text">
                            Cole aqui o link da pasta compartilhada onde os dados serão salvos.
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">✅ Vantagens</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li>• Suporte a múltiplos provedores</li>
                                        <li>• Não precisa de tokens/APIs</li>
                                        <li>• Configuração automática</li>
                                        <li>• Estrutura de pastas criada automaticamente</li>
                                        <li>• Sistema muito confiável</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">📋 Estrutura Automática</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li>• 📁 database/ - Banco de dados</li>
                                        <li>• 📁 backups/ - Backups do sistema</li>
                                        <li>• 📁 uploads/ - Atestados e fotos</li>
                                        <li>• 📁 logs/ - Logs do sistema</li>
                                        <li>• 📁 reports/ - Relatórios</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="testSharedLink()">
                            <i class="fas fa-check me-1"></i>Testar Link
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openDropboxHelp()">
                            <i class="fas fa-question me-1"></i>Ajuda
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Salvar Configuração
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Forms ocultos para ações -->
<form id="actionForm" method="POST" style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="action" id="actionInput">
</form>

<script>
function testConnection() {
    if (confirm('Deseja testar a conexão com o sistema de backup?')) {
        document.getElementById('actionInput').value = 'test_connection';
        document.getElementById('actionForm').submit();
    }
}

function forceSync() {
    if (confirm('Deseja forçar a sincronização do banco de dados?')) {
        document.getElementById('actionInput').value = 'force_sync';
        document.getElementById('actionForm').submit();
    }
}

function createBackup() {
    if (confirm('Deseja criar um backup manual do banco de dados?')) {
        document.getElementById('actionInput').value = 'create_backup';
        document.getElementById('actionForm').submit();
    }
}

function createBackupWithSharedLink() {
    if (confirm('Deseja criar um backup manual? O sistema irá gerar um backup local e as instruções de upload.')) {
        document.getElementById('actionInput').value = 'create_backup';
        document.getElementById('actionForm').submit();
    }
}

function copyToClipboard(text) {
    try {
        navigator.clipboard.writeText(text);
        
        // Feedback visual
        const btn = event.target.closest('button');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.classList.remove('btn-success');
        }, 2000);
    } catch (err) {
        // Fallback para navegadores mais antigos
        try {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Link copiado para a área de transferência!');
        } catch (fallbackErr) {
            alert('Não foi possível copiar automaticamente. Selecione e copie manualmente.');
        }
    }
}

function testSharedLink() {
    const link = document.getElementById('shared_link').value.trim();
    if (!link) {
        alert('Digite o link primeiro!');
        return;
    }
    
    if (!link.startsWith('https://www.dropbox.com/')) {
        alert('O link deve ser um link válido do Dropbox!');
        return;
    }
    
    // Tentar abrir o link
    window.open(link, '_blank');
    
    // Feedback
    const btn = event.target;
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>Testado';
    btn.classList.remove('btn-outline-info');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalContent;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-info');
    }, 3000);
}

function openDropboxHelp() {
    const helpContent = `
Como criar um link compartilhado do Dropbox:

1. Acesse sua conta no Dropbox (www.dropbox.com)
2. Crie uma pasta chamada "SKPONTO_Backups"
3. Clique com o botão direito na pasta
4. Selecione "Compartilhar" ou "Share"
5. Clique em "Criar link" ou "Create link"
6. Copie o link gerado
7. Cole o link no campo de configuração

O link deve ter o formato:
https://www.dropbox.com/scl/fo/...

Dicas:
- Certifique-se de que a pasta seja dedicada apenas aos backups
- Não altere o nome da pasta após criar o link
- Mantenha o link seguro e não o compartilhe
    `;
    
    alert(helpContent);
}
</script>
{% endblock %}
