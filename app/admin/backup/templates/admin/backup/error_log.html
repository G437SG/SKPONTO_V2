{% extends "base.html" %}

{% block title %}Log de Erros - Backup Dashboard - SKPONTO{% endblock %}

{% block extra_css %}
<style>
    .error-card {
        border-left: 4px solid #dc3545;
        margin-bottom: 20px;
    }
    .success-card {
        border-left: 4px solid #28a745;
        margin-bottom: 20px;
    }
    .warning-card {
        border-left: 4px solid #ffc107;
        margin-bottom: 20px;
    }
    .code-block {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        overflow-x: auto;
        white-space: pre-wrap;
    }
    .test-result {
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
    }
    .test-passed {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    .test-failed {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    .timestamp {
        font-size: 0.9em;
        color: #6c757d;
    }
    .user-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-exclamation-triangle text-warning"></i> Log de Erros - Sistema de Backup</h2>
                    <p class="text-muted mb-0">Diagnóstico detalhado de erros e problemas do sistema de backup</p>
                </div>
                <div>
                    <a href="{{ url_for('backup.dashboard') }}" class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
                    </a>
                    <button class="btn btn-outline-secondary" onclick="refreshDiagnosis()">
                        <i class="fas fa-sync-alt"></i> Atualizar Diagnóstico
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Info -->
    {% if user_info %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card user-info">
                <div class="card-body">
                    <h5><i class="fas fa-user"></i> Informações do Usuário</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>ID:</strong> {{ user_info.id }}
                        </div>
                        <div class="col-md-4">
                            <strong>Email:</strong> {{ user_info.email }}
                        </div>
                        <div class="col-md-3">
                            <strong>Tipo:</strong> {{ user_info.user_type }}
                        </div>
                        <div class="col-md-2">
                            <strong>Admin:</strong> 
                            {% if user_info.is_admin %}
                                <span class="badge badge-success">Sim</span>
                            {% else %}
                                <span class="badge badge-danger">Não</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Error Data (se existir) -->
    {% if error_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card error-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-bug"></i> Erro Detectado</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Tipo:</strong> {{ error_data.error_type }}<br>
                            <strong>Timestamp:</strong> <span class="timestamp">{{ error_data.timestamp }}</span><br>
                            <strong>Usuário:</strong> {{ error_data.user }}<br>
                            <strong>Endpoint:</strong> {{ error_data.request_path }}
                        </div>
                        <div class="col-md-6">
                            <strong>Método:</strong> {{ error_data.request_method }}<br>
                            <strong>User-Agent:</strong> <small>{{ error_data.user_agent[:50] }}...</small>
                        </div>
                    </div>
                    <hr>
                    <h6>Mensagem de Erro:</h6>
                    <div class="alert alert-danger">{{ error_data.error_message }}</div>
                    
                    {% if error_data.traceback %}
                    <h6>Stack Trace:</h6>
                    <div class="code-block">{{ error_data.traceback }}</div>
                    {% endif %}
                    
                    {% if error_data.context %}
                    <h6>Contexto:</h6>
                    <div class="code-block">{{ error_data.context | tojson(indent=2) }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Diagnosis Results -->
    {% if diagnosis_result %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card {% if diagnosis_result.summary == 'OK' %}success-card{% elif diagnosis_result.summary == 'AVISOS' %}warning-card{% else %}error-card{% endif %}">
                <div class="card-header {% if diagnosis_result.summary == 'OK' %}bg-success{% elif diagnosis_result.summary == 'AVISOS' %}bg-warning{% else %}bg-danger{% endif %} text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-stethoscope"></i> Diagnóstico do Sistema
                        <span class="badge badge-light ml-2">{{ diagnosis_result.summary }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <p class="timestamp">Executado em: {{ diagnosis_result.timestamp }}</p>
                    
                    <!-- Critical Errors -->
                    {% if diagnosis_result.critical_errors %}
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> Erros Críticos:</h6>
                        <ul class="mb-0">
                            {% for error in diagnosis_result.critical_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <!-- Warnings -->
                    {% if diagnosis_result.warnings %}
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Avisos:</h6>
                        <ul class="mb-0">
                            {% for warning in diagnosis_result.warnings %}
                            <li>{{ warning }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <!-- Test Results -->
                    {% if diagnosis_result.tests %}
                    <h6><i class="fas fa-flask"></i> Resultados dos Testes:</h6>
                    {% for test in diagnosis_result.tests %}
                    <div class="test-result {% if test.passed %}test-passed{% else %}test-failed{% endif %}">
                        <strong>{{ test.name }}:</strong>
                        {% if test.passed %}
                            <span class="badge badge-success">PASSOU</span>
                            {% if test.message %}
                                - {{ test.message }}
                            {% endif %}
                        {% else %}
                            <span class="badge badge-danger">FALHOU</span>
                            {% if test.error %}
                                - {{ test.error }}
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tools"></i> Ações Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group mr-2" role="group">
                        <button class="btn btn-outline-primary" onclick="testConnection()">
                            <i class="fas fa-plug"></i> Testar Conexão
                        </button>
                        <button class="btn btn-outline-info" onclick="clearLogs()">
                            <i class="fas fa-broom"></i> Limpar Logs
                        </button>
                        <button class="btn btn-outline-success" onclick="exportLogs()">
                            <i class="fas fa-download"></i> Exportar Logs
                        </button>
                    </div>
                    
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-warning" onclick="resetBackupSystem()">
                            <i class="fas fa-redo"></i> Reinicializar Sistema
                        </button>
                        <button class="btn btn-outline-secondary" onclick="viewSystemInfo()">
                            <i class="fas fa-info-circle"></i> Info do Sistema
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Log -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-stream"></i> Log em Tempo Real</h5>
                </div>
                <div class="card-body">
                    <div id="realtime-log" class="code-block" style="height: 300px; overflow-y: auto;">
                        Aguardando eventos...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Carregando...</span>
                </div>
                <p class="mt-2">Executando diagnóstico...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshDiagnosis() {
    showLoading();
    fetch('{{ url_for("backup.api_diagnosis") }}')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            location.reload();
        })
        .catch(error => {
            hideLoading();
            console.error('Erro:', error);
            addToLog('ERRO: Falha ao atualizar diagnóstico - ' + error.message);
        });
}

function testConnection() {
    addToLog('TESTE: Iniciando teste de conexão...');
    fetch('{{ url_for("backup.api_storage_info") }}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                addToLog('SUCESSO: Conexão com sistema de backup OK');
            } else {
                addToLog('AVISO: Conexão com problemas - ' + data.message);
            }
        })
        .catch(error => {
            addToLog('ERRO: Falha na conexão - ' + error.message);
        });
}

function clearLogs() {
    if (confirm('Deseja realmente limpar todos os logs?')) {
        addToLog('INFO: Logs limpos pelo usuário');
        document.getElementById('realtime-log').innerHTML = 'Logs limpos...\n';
    }
}

function exportLogs() {
    addToLog('INFO: Exportando logs...');
    // Implementar exportação de logs
    alert('Funcionalidade de exportação em desenvolvimento');
}

function resetBackupSystem() {
    if (confirm('Deseja reinicializar o sistema de backup? Isso pode resolver problemas de configuração.')) {
        addToLog('AÇÃO: Reinicializando sistema de backup...');
        // Implementar reset do sistema
        alert('Funcionalidade de reset em desenvolvimento');
    }
}

function viewSystemInfo() {
    addToLog('INFO: Visualizando informações do sistema...');
    const info = {
        timestamp: new Date().toISOString(),
        user_agent: navigator.userAgent,
        screen_resolution: screen.width + 'x' + screen.height,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
    addToLog('SISTEMA: ' + JSON.stringify(info, null, 2));
}

function addToLog(message) {
    const logElement = document.getElementById('realtime-log');
    const timestamp = new Date().toLocaleString();
    logElement.innerHTML += `[${timestamp}] ${message}\n`;
    logElement.scrollTop = logElement.scrollHeight;
}

function showLoading() {
    $('#loadingModal').modal('show');
}

function hideLoading() {
    $('#loadingModal').modal('hide');
}

// Adicionar eventos iniciais ao log
document.addEventListener('DOMContentLoaded', function() {
    addToLog('SISTEMA: Página de diagnóstico carregada');
    addToLog('USUÁRIO: {{ user_info.email if user_info else "Anônimo" }}');
    addToLog('STATUS: Sistema pronto para diagnóstico');
});

// Auto-refresh do diagnóstico a cada 60 segundos
setInterval(function() {
    fetch('{{ url_for("backup.api_diagnosis") }}')
        .then(response => response.json())
        .then(data => {
            if (data.summary !== 'OK') {
                addToLog('ALERTA: Problemas detectados no sistema - ' + data.summary);
            }
        })
        .catch(error => {
            addToLog('ERRO: Falha na verificação automática - ' + error.message);
        });
}, 60000);
</script>
{% endblock %}
