{% extends "base.html" %}

{% block title %}Dashboard de Backup - SKPONTO{% endblock %}

{% block extra_css %}
<style>
    .backup-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    .backup-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .storage-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .backup-item {
        border-left: 3px solid #28a745;
        margin-bottom: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        transition: all 0.3s ease;
    }
    .backup-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }
    .backup-item.selected {
        background: #d1ecf1;
        border-left-color: #17a2b8;
    }
    .progress-custom {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    .progress-bar-custom {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }
    .action-buttons {
        position: sticky;
        top: 20px;
        z-index: 1000;
    }
    .settings-panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .bulk-actions {
        display: none;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .bulk-actions.show {
        display: block;
    }
    .select-all-checkbox {
        transform: scale(1.2);
    }
    .backup-checkbox {
        transform: scale(1.1);
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-database"></i> Gerenciamento de Backup</h2>
                    <p class="text-muted mb-0">Gerencie backups do sistema SKPONTO com controle avançado</p>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="createBackup()">
                        <i class="fas fa-plus"></i> Criar Backup
                    </button>
                    <button class="btn btn-info" onclick="toggleSettings()">
                        <i class="fas fa-cog"></i> Configurações
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2 text-muted">Processando operação...</p>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel" style="display: none;">
        <h5><i class="fas fa-cog"></i> Configurações de Backup</h5>
        
        <!-- Auto Backup Configuration -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-clock"></i> Backup Automático</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoBackupEnabled">
                            <label class="form-check-label" for="autoBackupEnabled">
                                Habilitar backup automático
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="backupFrequency">Frequência:</label>
                            <select id="backupFrequency" class="form-control">
                                <option value="daily">Diário</option>
                                <option value="weekly">Semanal</option>
                                <option value="monthly">Mensal</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="backupTime">Horário:</label>
                            <input type="time" id="backupTime" class="form-control" value="02:00">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div>
                                <button class="btn btn-success btn-sm" onclick="triggerAutoBackup()">
                                    <i class="fas fa-play"></i> Executar Agora
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Manual Backup Configuration -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools"></i> Configurações Manuais</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="maxBackups">Máximo de backups a manter:</label>
                            <input type="number" id="maxBackups" class="form-control" value="10" min="1" max="100">
                            <small class="form-text text-muted">Backups mais antigos serão removidos automaticamente</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoCleanup" checked>
                                <label class="form-check-label" for="autoCleanup">
                                    Limpeza automática
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div>
                                <button class="btn btn-primary" onclick="saveAllSettings()">
                                    <i class="fas fa-save"></i> Salvar Configurações
                                </button>
                                <button class="btn btn-warning" onclick="cleanupOldBackups()">
                                    <i class="fas fa-broom"></i> Limpar Agora
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Info Cards -->
    <div class="stats-card">
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <i class="fas fa-hdd fa-2x mb-3"></i>
                    <h5>Espaço Total</h5>
                    <h3 id="total-space">{{ "%.1f"|format((storage_info.total_size or 0) / 1024 / 1024) }} MB</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="fas fa-archive fa-2x mb-3"></i>
                    <h5>Total de Backups</h5>
                    <h3 id="backup-count">{{ storage_info.backup_count or 0 }}</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="fas fa-chart-pie fa-2x mb-3"></i>
                    <h5>Espaço Usado</h5>
                    <h3 id="used-space">{{ "%.1f"|format((storage_info.used_space or 0) / 1024 / 1024) }} MB</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="fas fa-check-circle fa-2x mb-3"></i>
                    <h5>Status</h5>
                    <span class="badge badge-light p-2">
                        {{ storage_info.message or 'OK' }}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Storage Usage Progress -->
        <div class="mt-4">
            <h6>Uso do Armazenamento</h6>
            <div class="progress-custom">
                {% set usage_percent = ((storage_info.used_space or 0) / (storage_info.free_space or 1000000000) * 100) %}
                <div class="progress-bar-custom" style="width: {{ usage_percent }}%"></div>
            </div>
            <div class="mt-2">
                <small>{{ "%.1f"|format(usage_percent) }}% usado - {{ "%.1f"|format((storage_info.free_space or 0) / 1024 / 1024 / 1024) }} GB livres</small>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Panel -->
    <div id="bulkActions" class="bulk-actions">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong><span id="selectedCount">0</span> backup(s) selecionado(s)</strong>
            </div>
            <div>
                <button class="btn btn-danger btn-sm" onclick="deleteSelectedBackups()">
                    <i class="fas fa-trash"></i> Deletar Selecionados
                </button>
                <button class="btn btn-secondary btn-sm ml-2" onclick="clearSelection()">
                    <i class="fas fa-times"></i> Limpar Seleção
                </button>
            </div>
        </div>
    </div>

    <!-- Backups List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Lista de Backups</h5>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input select-all-checkbox" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                <label class="form-check-label" for="selectAll">Selecionar Todos</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if backups %}
                        <div id="backups-list">
                            {% for backup in backups %}
                            <div class="backup-item" data-backup-name="{{ backup.name }}">
                                <div class="row align-items-center">
                                    <div class="col-md-1">
                                        <div class="form-check">
                                            <input class="form-check-input backup-checkbox" type="checkbox" 
                                                   value="{{ backup.name }}" id="backup_{{ loop.index }}" 
                                                   onchange="updateSelection()">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="mb-1">{{ backup.name }}</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar"></i> {{ backup.created_at.strftime('%d/%m/%Y %H:%M:%S') }}
                                        </small>
                                    </div>
                                    <div class="col-md-2">
                                        <span class="badge badge-info">
                                            <i class="fas fa-weight"></i> {{ "%.1f"|format(backup.size / 1024 / 1024) }} MB
                                        </span>
                                    </div>
                                    <div class="col-md-5 text-right">
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('backup.download_backup', backup_name=backup.name) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                            <button class="btn btn-sm btn-outline-warning" 
                                                    onclick="showBackupDetails('{{ backup.name }}', '{{ backup.size }}', '{{ backup.created_at.strftime('%d/%m/%Y %H:%M:%S') }}')">
                                                <i class="fas fa-info-circle"></i> Detalhes
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteBackup('{{ backup.name }}')">
                                                <i class="fas fa-trash"></i> Deletar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                            <h5>Nenhum backup encontrado</h5>
                            <p class="text-muted">Clique em "Criar Backup" para fazer seu primeiro backup do sistema.</p>
                            <button class="btn btn-primary mt-3" onclick="createBackup()">
                                <i class="fas fa-plus"></i> Criar Primeiro Backup
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">Processando...</p>
            </div>
        </div>
    </div>
</div>

<!-- Backup Details Modal -->
<div class="modal fade" id="backupDetailsModal" tabindex="-1" aria-labelledby="backupDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backupDetailsModalLabel"><i class="fas fa-info-circle"></i> Detalhes do Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Nome:</strong></td>
                                <td id="detailName">-</td>
                            </tr>
                            <tr>
                                <td><strong>Tamanho:</strong></td>
                                <td id="detailSize">-</td>
                            </tr>
                            <tr>
                                <td><strong>Data de Criação:</strong></td>
                                <td id="detailDate">-</td>
                            </tr>
                            <tr>
                                <td><strong>Tipo:</strong></td>
                                <td id="detailType">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel"><i class="fas fa-exclamation-triangle text-warning"></i> Confirmação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Tem certeza que deseja continuar?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variáveis globais
let selectedBackups = [];
let confirmCallback = null;
let loadingModal, backupDetailsModal, confirmationModal;

// Inicializar modais Bootstrap 5
document.addEventListener('DOMContentLoaded', function() {
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    backupDetailsModal = new bootstrap.Modal(document.getElementById('backupDetailsModal'));
    confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    
    // Configurar botão de confirmação
    document.getElementById('confirmButton').addEventListener('click', function() {
        confirmationModal.hide();
        if (confirmCallback) {
            confirmCallback();
            confirmCallback = null;
        }
    });
    
    // Auto-refresh a cada 60 segundos
    setInterval(updateStats, 60000);
});

// Funções de criação e gerenciamento de backup
function createBackup() {
    showConfirmation('Deseja criar um novo backup do sistema?', function() {
        showLoading();
        
        console.log('Iniciando criação de backup...');
        
        fetch('{{ url_for("backup.create_backup") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            console.log('Resposta recebida:', response.status);
            return response.text().then(text => {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.log('Resposta não é JSON:', text);
                    throw new Error('Resposta inválida do servidor');
                }
            });
        })
        .then(data => {
            hideLoading();
            console.log('Dados recebidos:', data);
            
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.message || 'Erro desconhecido', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Erro:', error);
            showNotification('Erro ao criar backup: ' + error.message, 'error');
        });
    });
}

function deleteBackup(backupName) {
    showConfirmation(
        `Deseja realmente deletar o backup "${backupName}"? Esta ação não pode ser desfeita.`,
        function() {
            performDeleteBackup(backupName);
        }
    );
}

function performDeleteBackup(backupName) {
    showLoading();
    
    const url = `{{ url_for('backup.delete_backup', backup_name='') }}${backupName}`;
    
    fetch(url, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(response => {
        hideLoading();
        if (response.ok) {
            showNotification('Backup deletado com sucesso!', 'success');
            removeBackupFromList(backupName);
            updateStats();
        } else {
            return response.text().then(text => {
                showNotification('Erro ao deletar backup: ' + text, 'error');
            });
        }
    }).catch(error => {
        hideLoading();
        console.error('Erro na requisição:', error);
        showNotification('Erro ao deletar backup: ' + error.message, 'error');
    });
}

// Funções de seleção múltipla
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const backupCheckboxes = document.querySelectorAll('.backup-checkbox');
    
    backupCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelection();
}

function updateSelection() {
    const backupCheckboxes = document.querySelectorAll('.backup-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    selectedBackups = [];
    let checkedCount = 0;
    
    backupCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedBackups.push(checkbox.value);
            checkedCount++;
        }
    });
    
    // Atualizar estado do "selecionar todos"
    selectAllCheckbox.checked = checkedCount === backupCheckboxes.length && checkedCount > 0;
    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < backupCheckboxes.length;
    
    // Mostrar/ocultar painel de ações em lote
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedBackups.length > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedBackups.length;
    } else {
        bulkActions.classList.remove('show');
    }
    
    // Atualizar visual dos itens selecionados
    document.querySelectorAll('.backup-item').forEach(item => {
        const checkbox = item.querySelector('.backup-checkbox');
        if (checkbox && checkbox.checked) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

function clearSelection() {
    const backupCheckboxes = document.querySelectorAll('.backup-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    backupCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectAllCheckbox.checked = false;
    
    updateSelection();
}

function deleteSelectedBackups() {
    if (selectedBackups.length === 0) {
        showNotification('Nenhum backup selecionado', 'warning');
        return;
    }
    
    const message = `Deseja realmente deletar ${selectedBackups.length} backup(s) selecionado(s)? Esta ação não pode ser desfeita.`;
    
    showConfirmation(message, function() {
        performDeleteMultipleBackups();
    });
}

function performDeleteMultipleBackups() {
    showLoading();
    
    fetch('{{ url_for("backup.delete_multiple_backups") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            backup_names: selectedBackups
        })
    }).then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            // Remover backups deletados da lista
            selectedBackups.forEach(backupName => {
                removeBackupFromList(backupName);
            });
            clearSelection();
            updateStats();
        } else {
            showNotification(data.message, 'error');
        }
    }).catch(error => {
        hideLoading();
        console.error('Erro:', error);
        showNotification('Erro ao deletar backups: ' + error.message, 'error');
    });
}

// Funções de configurações
function toggleSettings() {
    const settingsPanel = document.getElementById('settingsPanel');
    if (settingsPanel.style.display === 'none') {
        settingsPanel.style.display = 'block';
        loadSettings();
    } else {
        settingsPanel.style.display = 'none';
    }
}

function saveSettings() {
    const maxBackups = parseInt(document.getElementById('maxBackups').value);
    
    if (maxBackups < 1) {
        showNotification('O número máximo de backups deve ser maior que 0', 'error');
        return;
    }
    
    fetch('{{ url_for("backup.backup_settings") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            max_backups: maxBackups,
            auto_cleanup: false
        })
    }).then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'error');
        }
    }).catch(error => {
        console.error('Erro:', error);
        showNotification('Erro ao salvar configurações: ' + error.message, 'error');
    });
}

function cleanupOldBackups() {
    const maxBackups = parseInt(document.getElementById('maxBackups').value);
    
    showConfirmation(
        `Deseja limpar backups antigos mantendo apenas os ${maxBackups} mais recentes?`,
        function() {
            performCleanup(maxBackups);
        }
    );
}

function performCleanup(maxBackups) {
    showLoading();
    
    fetch('{{ url_for("backup.cleanup_backups") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            max_backups: maxBackups
        })
    }).then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message, 'error');
        }
    }).catch(error => {
        hideLoading();
        console.error('Erro:', error);
        showNotification('Erro ao limpar backups: ' + error.message, 'error');
    });
}

function loadSettings() {
    // Carregar configurações manuais
    fetch('{{ url_for("backup.backup_settings") }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('maxBackups').value = data.max_backups || 10;
        })
        .catch(error => {
            console.error('Erro ao carregar configurações manuais:', error);
        });
    
    // Carregar configurações de backup automático
    fetch('{{ url_for("backup.auto_backup_config") }}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const config = data.config;
                document.getElementById('autoBackupEnabled').checked = config.enabled || false;
                document.getElementById('backupFrequency').value = config.frequency || 'daily';
                document.getElementById('backupTime').value = config.time || '02:00';
                document.getElementById('autoCleanup').checked = config.auto_cleanup !== false;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar configurações de backup automático:', error);
        });
}

function performCleanup(maxBackups) {
    showLoading();
    
    fetch('{{ url_for("backup.cleanup_backups") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            max_backups: maxBackups
        })
    }).then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message, 'error');
        }
    }).catch(error => {
        hideLoading();
        console.error('Erro:', error);
        showNotification('Erro ao limpar backups: ' + error.message, 'error');
    });
}

function updateStats() {
    fetch('{{ url_for("backup.api_storage_info") }}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' || data.status === 'warning') {
                document.getElementById('total-space').textContent = 
                    (data.total_size / 1024 / 1024).toFixed(1) + ' MB';
                document.getElementById('backup-count').textContent = data.backup_count;
                document.getElementById('used-space').textContent = 
                    (data.used_space / 1024 / 1024).toFixed(1) + ' MB';
            }
        })
        .catch(error => console.error('Erro ao atualizar estatísticas:', error));
}

function getCsrfToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
}

function showLoading() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
    }
}

function hideLoading() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
    }
}

function showNotification(message, type = 'info') {
    // Remove notificações anteriores
    const existingNotification = document.querySelector('.alert-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Cria nova notificação
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-notification alert-dismissible fade show`;
    alertDiv.setAttribute('role', 'alert');
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Remove automaticamente após 5 segundos
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showConfirmation(message, onConfirm) {
    const confirmModal = document.getElementById('confirmationModal');
    const confirmBody = confirmModal.querySelector('.modal-body p');
    const confirmButton = confirmModal.querySelector('#confirmButton');
    
    confirmBody.textContent = message;
    
    // Remove listeners anteriores
    const newConfirmButton = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
    
    // Adiciona novo listener
    newConfirmButton.addEventListener('click', function() {
        onConfirm();
        const modal = bootstrap.Modal.getInstance(confirmModal);
        modal.hide();
    });
    
    const modal = new bootstrap.Modal(confirmModal);
    modal.show();
}

// Funções de backup automático
function saveAllSettings() {
    // Salvar configurações manuais
    saveSettings();
    
    // Salvar configurações de backup automático
    saveAutoBackupSettings();
}

function saveAutoBackupSettings() {
    const config = {
        enabled: document.getElementById('autoBackupEnabled').checked,
        frequency: document.getElementById('backupFrequency').value,
        time: document.getElementById('backupTime').value,
        max_backups: parseInt(document.getElementById('maxBackups').value),
        auto_cleanup: document.getElementById('autoCleanup').checked
    };
    
    fetch('{{ url_for("backup.auto_backup_config") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Configurações de backup automático salvas com sucesso!', 'success');
        } else {
            showNotification(data.message || 'Erro ao salvar configurações de backup automático', 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showNotification('Erro ao salvar configurações de backup automático: ' + error.message, 'error');
    });
}

function triggerAutoBackup() {
    showConfirmation('Deseja executar um backup automático agora?', function() {
        showLoading();
        
        fetch('{{ url_for("backup.trigger_auto_backup") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.message || 'Erro no backup automático', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Erro:', error);
            showNotification('Erro ao executar backup automático: ' + error.message, 'error');
        });
    });
}

// Funções auxiliares
function refreshData() {
    location.reload();
}

function showBackupDetails(name, size, date) {
    document.getElementById('detailName').textContent = name;
    document.getElementById('detailSize').textContent = (size / 1024 / 1024).toFixed(1) + ' MB';
    document.getElementById('detailDate').textContent = date;
    document.getElementById('detailType').textContent = 'Backup Completo';
    
    const modal = new bootstrap.Modal(document.getElementById('backupDetailsModal'));
    modal.show();
}

function removeBackupFromList(backupName) {
    const backupItem = document.querySelector(`[data-backup-name="${backupName}"]`);
    if (backupItem) {
        backupItem.remove();
    }
}
</script>
{% endblock %}
