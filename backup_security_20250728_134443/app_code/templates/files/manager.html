{% extends "base.html" %}

{% block title %}Gerenciador de Arquivos{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .file-manager-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .file-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .file-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.1);
    }
    
    .file-icon {
        font-size: 2rem;
        margin-right: 15px;
    }
    
    .file-info {
        flex: 1;
    }
    
    .file-name {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .file-meta {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .file-actions {
        display: flex;
        gap: 10px;
    }
    
    .btn-file-action {
        border: none;
        background: none;
        padding: 5px 10px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .btn-file-action:hover {
        background: #f8f9fa;
    }
    
    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background: #fafafa;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #007bff;
        background: #f0f8ff;
    }
    
    .upload-area.dragover {
        border-color: #007bff;
        background: #e7f3ff;
    }
    
    .toolbar {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .selected-files {
        background: #e3f2fd;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        display: none;
    }
    
    .breadcrumb {
        background: white;
        border-radius: 8px;
        padding: 10px 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-folder text-primary me-2"></i>
                    Gerenciador de Arquivos
                </h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-upload me-1"></i>
                        Enviar Arquivo
                    </button>
                    <button class="btn btn-success" onclick="createFolder()">
                        <i class="fas fa-folder-plus me-1"></i>
                        Nova Pasta
                    </button>
                </div>
            </div>
            
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('files.file_manager') }}">
                            <i class="fas fa-home"></i> Início
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Shared Storage</li>
                </ol>
            </nav>
            
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="selectAll()">
                                <i class="fas fa-check-square"></i> Selecionar Tudo
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                <i class="fas fa-square"></i> Limpar
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-outline-info btn-sm" onclick="refreshFiles()">
                                <i class="fas fa-sync"></i> Atualizar
                            </button>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-secondary btn-sm active" onclick="setView('grid')">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="setView('list')">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Selected Files Info -->
            <div id="selectedFilesInfo" class="selected-files">
                <i class="fas fa-info-circle me-2"></i>
                <span id="selectedCount">0</span> arquivos selecionados
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-sm btn-warning" onclick="createZip()">
                        <i class="fas fa-file-archive"></i> Criar ZIP
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSelected()">
                        <i class="fas fa-trash"></i> Deletar
                    </button>
                </div>
            </div>
            
            <!-- Files Container -->
            <div class="file-manager-container">
                {% if folders or files %}
                    <div id="filesContainer" class="row">
                        <!-- Folders -->
                        {% for folder in folders %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="file-item d-flex align-items-center" 
                                 data-name="{{ folder.name }}" 
                                 data-type="folder"
                                 onclick="selectFile(this)">
                                <input type="checkbox" class="form-check-input me-2 file-checkbox">
                                <i class="fas fa-folder file-icon text-warning"></i>
                                <div class="file-info">
                                    <div class="file-name">{{ folder.name }}</div>
                                    <div class="file-meta">
                                        Pasta • {{ folder.size }} • {{ folder.modified }}
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn-file-action" onclick="event.stopPropagation(); renameFile('{{ folder.name }}')">
                                        <i class="fas fa-edit text-primary"></i>
                                    </button>
                                    <button class="btn-file-action" onclick="event.stopPropagation(); deleteFile('{{ folder.name }}')">
                                        <i class="fas fa-trash text-danger"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Files -->
                        {% for file in files %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="file-item d-flex align-items-center" 
                                 data-name="{{ file.name }}" 
                                 data-type="file"
                                 onclick="selectFile(this)">
                                <input type="checkbox" class="form-check-input me-2 file-checkbox">
                                <i class="{{ file.get_icon_class() if file.get_icon_class else 'fas fa-file text-muted' }} file-icon"></i>
                                <div class="file-info">
                                    <div class="file-name">{{ file.name }}</div>
                                    <div class="file-meta">
                                        {{ file.size }} • {{ file.modified }}
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn-file-action" onclick="event.stopPropagation(); downloadFile('{{ file.name }}')">
                                        <i class="fas fa-download text-success"></i>
                                    </button>
                                    <button class="btn-file-action" onclick="event.stopPropagation(); showFileInfo('{{ file.name }}')">
                                        <i class="fas fa-info text-info"></i>
                                    </button>
                                    <button class="btn-file-action" onclick="event.stopPropagation(); renameFile('{{ file.name }}')">
                                        <i class="fas fa-edit text-primary"></i>
                                    </button>
                                    <button class="btn-file-action" onclick="event.stopPropagation(); deleteFile('{{ file.name }}')">
                                        <i class="fas fa-trash text-danger"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-folder-open text-muted" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-muted">Nenhum arquivo encontrado</h4>
                        <p class="text-muted">Faça upload de arquivos para começar</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload text-primary me-2"></i>
                    Enviar Arquivos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" action="{{ url_for('files.upload_file') }}" method="POST" enctype="multipart/form-data">
                    {{ csrf_token() }}
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt text-muted" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Arraste arquivos aqui ou clique para selecionar</h4>
                        <p class="text-muted">Tamanho máximo: 50MB por arquivo</p>
                        <input type="file" class="form-control" name="file" id="fileInput" style="display: none;" multiple>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-1"></i>
                            Selecionar Arquivos
                        </button>
                    </div>
                    <div id="selectedFiles" class="mt-3" style="display: none;">
                        <h6>Arquivos Selecionados:</h6>
                        <div id="fileList"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="uploadFiles()">
                    <i class="fas fa-upload me-1"></i>
                    Enviar Arquivos
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Info Modal -->
<div class="modal fade" id="fileInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    Informações do Arquivo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="fileInfoContent">
                <!-- Conteúdo carregado via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-primary me-2"></i>
                    Renomear
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameForm">
                    {{ csrf_token() }}
                    <input type="hidden" id="oldName" name="old_name">
                    <div class="mb-3">
                        <label for="newName" class="form-label">Novo nome:</label>
                        <input type="text" class="form-control" id="newName" name="new_name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitRename()">
                    <i class="fas fa-save me-1"></i>
                    Renomear
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder-plus text-success me-2"></i>
                    Nova Pasta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createFolderForm" action="{{ url_for('files.create_folder') }}" method="POST">
                    {{ csrf_token() }}
                    <div class="mb-3">
                        <label for="folderName" class="form-label">Nome da pasta:</label>
                        <input type="text" class="form-control" id="folderName" name="folder_name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="submitCreateFolder()">
                    <i class="fas fa-plus me-1"></i>
                    Criar Pasta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create ZIP Modal -->
<div class="modal fade" id="createZipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-archive text-warning me-2"></i>
                    Criar Arquivo ZIP
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createZipForm">
                    {{ csrf_token() }}
                    <div class="mb-3">
                        <label for="zipName" class="form-label">Nome do arquivo ZIP:</label>
                        <input type="text" class="form-control" id="zipName" name="zip_name" value="arquivos.zip" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Arquivos selecionados:</label>
                        <div id="zipFileList" class="border rounded p-2 bg-light">
                            <!-- Lista preenchida via JavaScript -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="submitCreateZip()">
                    <i class="fas fa-file-archive me-1"></i>
                    Criar ZIP
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Variáveis globais
let selectedFiles = [];
let currentView = 'grid';

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    setupDragAndDrop();
    setupFileInput();
});

// Funções de seleção
function selectFile(element) {
    const checkbox = element.querySelector('.file-checkbox');
    const fileName = element.dataset.name;
    
    if (checkbox.checked) {
        checkbox.checked = false;
        selectedFiles = selectedFiles.filter(f => f !== fileName);
        element.classList.remove('selected');
    } else {
        checkbox.checked = true;
        selectedFiles.push(fileName);
        element.classList.add('selected');
    }
    
    updateSelectedFilesInfo();
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    const fileItems = document.querySelectorAll('.file-item');
    
    selectedFiles = [];
    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = true;
        fileItems[index].classList.add('selected');
        selectedFiles.push(fileItems[index].dataset.name);
    });
    
    updateSelectedFilesInfo();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    const fileItems = document.querySelectorAll('.file-item');
    
    selectedFiles = [];
    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = false;
        fileItems[index].classList.remove('selected');
    });
    
    updateSelectedFilesInfo();
}

function updateSelectedFilesInfo() {
    const selectedFilesInfo = document.getElementById('selectedFilesInfo');
    const selectedCount = document.getElementById('selectedCount');
    
    selectedCount.textContent = selectedFiles.length;
    
    if (selectedFiles.length > 0) {
        selectedFilesInfo.style.display = 'block';
    } else {
        selectedFilesInfo.style.display = 'none';
    }
}

// Funções de ação
function downloadFile(filename) {
    window.location.href = `{{ url_for('files.download_file', filename='') }}${filename}`;
}

function deleteFile(filename) {
    if (confirm(`Tem certeza que deseja deletar "${filename}"?`)) {
        window.location.href = `{{ url_for('files.delete_file', filename='') }}${filename}`;
    }
}

function deleteSelected() {
    if (selectedFiles.length === 0) {
        alert('Nenhum arquivo selecionado');
        return;
    }
    
    if (confirm(`Tem certeza que deseja deletar ${selectedFiles.length} arquivo(s)?`)) {
        // Implementar exclusão em lote
        selectedFiles.forEach(filename => {
            window.location.href = `{{ url_for('files.delete_file', filename='') }}${filename}`;
        });
    }
}

function renameFile(filename) {
    document.getElementById('oldName').value = filename;
    document.getElementById('newName').value = filename;
    new bootstrap.Modal(document.getElementById('renameModal')).show();
}

function submitRename() {
    const form = document.getElementById('renameForm');
    const formData = new FormData(form);
    
    fetch(`{{ url_for('files.rename_file') }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        alert('Erro: ' + error.message);
    });
}

function createFolder() {
    new bootstrap.Modal(document.getElementById('createFolderModal')).show();
}

function submitCreateFolder() {
    document.getElementById('createFolderForm').submit();
}

function createZip() {
    if (selectedFiles.length === 0) {
        alert('Selecione pelo menos um arquivo');
        return;
    }
    
    const zipFileList = document.getElementById('zipFileList');
    zipFileList.innerHTML = selectedFiles.map(file => `<div>${file}</div>`).join('');
    
    new bootstrap.Modal(document.getElementById('createZipModal')).show();
}

function submitCreateZip() {
    const form = document.getElementById('createZipForm');
    const formData = new FormData(form);
    
    // Adicionar arquivos selecionados
    selectedFiles.forEach(file => {
        formData.append('files', file);
    });
    
    fetch(`{{ url_for('files.create_zip') }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        alert('Erro: ' + error.message);
    });
}

function showFileInfo(filename) {
    fetch(`{{ url_for('files.file_info', filename='') }}${filename}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erro: ' + data.error);
            return;
        }
        
        const content = document.getElementById('fileInfoContent');
        content.innerHTML = `
            <table class="table table-borderless">
                <tr><td><strong>Nome:</strong></td><td>${data.name}</td></tr>
                <tr><td><strong>Tamanho:</strong></td><td>${data.size}</td></tr>
                <tr><td><strong>Tipo:</strong></td><td>${data.type}</td></tr>
                <tr><td><strong>Modificado:</strong></td><td>${data.modified}</td></tr>
                <tr><td><strong>Criado:</strong></td><td>${data.created}</td></tr>
                ${data.extension ? `<tr><td><strong>Extensão:</strong></td><td>${data.extension}</td></tr>` : ''}
                ${data.mime_type ? `<tr><td><strong>Tipo MIME:</strong></td><td>${data.mime_type}</td></tr>` : ''}
                ${data.uploaded_by ? `<tr><td><strong>Enviado por:</strong></td><td>${data.uploaded_by}</td></tr>` : ''}
                ${data.upload_date ? `<tr><td><strong>Data de upload:</strong></td><td>${data.upload_date}</td></tr>` : ''}
            </table>
        `;
        
        new bootstrap.Modal(document.getElementById('fileInfoModal')).show();
    })
    .catch(error => {
        alert('Erro: ' + error.message);
    });
}

// Funções de upload
function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        handleFiles(files);
    });
}

function setupFileInput() {
    const fileInput = document.getElementById('fileInput');
    
    fileInput.addEventListener('change', function(e) {
        const files = e.target.files;
        handleFiles(files);
    });
}

function handleFiles(files) {
    const fileList = document.getElementById('fileList');
    const selectedFilesDiv = document.getElementById('selectedFiles');
    
    fileList.innerHTML = '';
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileItem = document.createElement('div');
        fileItem.className = 'border rounded p-2 mb-2 d-flex justify-content-between align-items-center';
        fileItem.innerHTML = `
            <div>
                <i class="fas fa-file me-2"></i>
                <span>${file.name}</span>
                <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
            </div>
            <span class="badge bg-primary">Pronto</span>
        `;
        fileList.appendChild(fileItem);
    }
    
    selectedFilesDiv.style.display = 'block';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function uploadFiles() {
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    
    if (fileInput.files.length === 0) {
        alert('Selecione pelo menos um arquivo');
        return;
    }
    
    // Submeter formulário
    form.submit();
}

// Funções de visualização
function setView(view) {
    currentView = view;
    const container = document.getElementById('filesContainer');
    
    // Remover classes de visualização anteriores
    container.classList.remove('row');
    
    if (view === 'grid') {
        container.classList.add('row');
        // Atualizar botões
        document.querySelectorAll('[onclick="setView(\'grid\')"]')[0].classList.add('active');
        document.querySelectorAll('[onclick="setView(\'list\')"]')[0].classList.remove('active');
    } else {
        // Implementar visualização em lista
        document.querySelectorAll('[onclick="setView(\'list\')"]')[0].classList.add('active');
        document.querySelectorAll('[onclick="setView(\'grid\')"]')[0].classList.remove('active');
    }
}

function refreshFiles() {
    location.reload();
}

// CSS para arquivos selecionados
const style = document.createElement('style');
style.textContent = `
    .file-item.selected {
        background-color: #e3f2fd !important;
        border-color: #2196f3 !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
